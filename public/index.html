<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ 1-–Ω–∞-1</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#121212; color:#00ff88; text-align:center; }
    h1 { margin-top: 20px; }
    .video-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    video { width: 45%; max-width: 600px; border: 3px solid #00ff88; border-radius: 12px; background: #000; box-shadow: 0 0 15px rgba(0, 255, 136, 0.2); }
    #local { transform: scaleX(-1); }
    #status { font-size: 1.2em; margin: 20px; padding: 10px; background: #1e1e1e; display: inline-block; border-radius: 8px; }
    #chat { width: 90%; max-width: 600px; margin: 30px auto; text-align: left; background: #1e1e1e; padding: 15px; border-radius: 12px; }
    #messages { height: 200px; overflow-y: auto; margin-bottom: 10px; padding-right: 10px; }
    .msg { margin: 8px 0; padding: 8px; background: #2a2a2a; border-radius: 6px; }
    .msg b { color: #fff; }
    .input-group { display: flex; gap: 10px; }
    input { flex: 1; padding: 12px; border: 1px solid #333; border-radius: 6px; background: #111; color: #fff; outline: none; }
    input:focus { border-color: #00ff88; }
    button { padding: 12px 20px; background: #00ff88; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button:hover { background: #00cc6a; }
  </style>
</head>
<body>
  <h1>üé• –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h1>
  <div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>

  <div class="video-container">
    <video id="local" autoplay muted playsinline></video>
    <video id="remote" autoplay playsinline></video>
  </div>

  <div id="chat">
    <div id="messages"></div>
    <div class="input-group">
      <input id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
      <button onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const socket = io();
    let localStream, peerConnection, myRole;
    
    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ STUN —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–±–∏–≤–∞–µ–º–æ—Å—Ç–∏ NAT
    const config = { 
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
      ] 
    };

    const localVideo = document.getElementById('local');
    const remoteVideo = document.getElementById('remote');
    const statusEl = document.getElementById('status');
    const messages = document.getElementById('messages');

    async function startMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        socket.emit('media-ready'); // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É, —á—Ç–æ –∫–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
      } catch (err) {
        statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
        console.error('–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞:', err);
      }
    }

    function createPeer() {
      if (peerConnection) peerConnection.close(); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
      peerConnection = new RTCPeerConnection(config);
      
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      
      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };
      
      peerConnection.onicecandidate = e => {
        if (e.candidate) socket.emit('ice-candidate', e.candidate);
      };
    }

    socket.on('status', async (state, role) => {
      if (state === 'busy') {
        statusEl.innerHTML = '‚ùå –ö–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
        return;
      }
      myRole = role;
      statusEl.innerHTML = `–í—ã ‚Äî <b>–ê–±–æ–Ω–µ–Ω—Ç ${role}</b>. –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞...`;
      await startMedia();
    });

    socket.on('start-call', async () => {
      statusEl.innerHTML = `–í—ã ‚Äî <b>–ê–±–æ–Ω–µ–Ω—Ç ${myRole}</b>. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! üîí`;
      createPeer();
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit('offer', offer);
    });

    socket.on('offer', async (offer) => {
      statusEl.innerHTML = `–í—ã ‚Äî <b>–ê–±–æ–Ω–µ–Ω—Ç ${myRole}</b>. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! üîí`;
      createPeer();
      await peerConnection.setRemoteDescription(offer);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.emit('answer', answer);
    });

    socket.on('answer', async (answer) => {
      await peerConnection.setRemoteDescription(answer);
    });

    socket.on('ice-candidate', async (candidate) => {
      if (peerConnection) {
        try {
          await peerConnection.addIceCandidate(candidate);
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞', e);
        }
      }
    });

    socket.on('chat', (data) => {
      addMessageToChat(`–ê–±–æ–Ω–µ–Ω—Ç ${data.from}`, data.text);
    });

    socket.on('reset', () => {
      statusEl.innerHTML = `–ü–∞—Ä—Ç–Ω—ë—Ä –æ—Ç–∫–ª—é—á–∏–ª—Å—è. –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞...`;
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      remoteVideo.srcObject = null;
    });

    function addMessageToChat(sender, text) {
      const div = document.createElement('div');
      div.className = 'msg';
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º textContent –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS –∏–Ω—ä–µ–∫—Ü–∏–π
      const b = document.createElement('b');
      b.textContent = sender + ': ';
      div.appendChild(b);
      div.appendChild(document.createTextNode(text));
      
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function sendChat() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (text) {
        socket.emit('chat', text);
        addMessageToChat('–Ø', text);
        input.value = '';
      }
    }

    document.getElementById('msgInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') sendChat();
    });
  </script>
</body>
</html>